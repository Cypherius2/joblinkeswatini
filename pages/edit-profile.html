<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile | JobLinkEswatini</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div id="notification-container"></div>
    <header class="main-header">
        <div class="container">
            <!-- Header Left: Logo & Search -->
            <div class="header-left">
                <!-- THIS IS THE CORRECT, RESTORED LOGO -->
                <a href="../index.html" class="logo-link">
                    <h1 class="logo">JobLink<span class="logo-eswatini">Eswatini</span></h1>
                </a>
                <div class="header-search-container">
                    <svg class="header-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                    <input type="text" class="header-search-input" placeholder="Search">
                </div>
            </div>

            <!-- Header Right: Navigation (This part remains the same) -->
            <nav class="main-nav" id="main-nav">
                <a href="../index.html" class="header-nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                    </svg>
                    <span>Home</span>
                </a>
                <a href="message-center.html" class="header-nav-item" id="messagingLink">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                    </svg>
                    <span>My Network</span>
                </a>
                <a href="jobs.html" class="header-nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z" />
                    </svg>
                    <span>Jobs</span>
                </a>
                <a href="message-center.html" class="header-nav-item" id="messagingLink">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" />
                    </svg>
                    <span>Messaging</span>
                    <span class="notification-badge" id="messaging-notification-dot"></span>
                </a>

                <div class="auth-buttons">
                    <div id="loggedOutNav" style="display: flex;">
                        <a href="login.html" class="header-nav-item">Sign In</a>
                    </div>
                    <div class="profile-dropdown-container header-nav-item header-nav-item--me" id="loggedInNav"
                        style="display: none;">
                        <img src="../assets/placeholder.svg" alt="My Profile" class="nav-profile-pic" id="navProfilePic">
                        <span>Me &#9662;</span>
                        <div class="profile-dropdown-menu" id="profileDropdownMenu">
                            <a href="profile.html" class="dropdown-link">View Profile</a>
                            <a href="edit-profile.html" class="dropdown-link">Edit Profile</a>
                            <a href="#" class="dropdown-link" id="signOutBtn">Sign Out</a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="page-main">
        <div class="container page-container-profile">
            <section class="profile-section-card">
                <h2>Edit Your Profile</h2>
                <p>Keep your professional information up to date.</p>

                <form id="editProfileForm" class="auth-form" style="text-align: left;">
                    <!-- Profile Picture Upload Section -->
                    <div class="form-group profile-picture-edit-section">
                        <label>Profile Picture</label>
                        <div class="profile-picture-upload-container">
                            <div class="current-profile-picture-container">
                                <img id="currentProfilePicture" src="../assets/placeholder.svg" alt="Current Profile Picture" class="current-profile-picture">
                                <div class="upload-overlay">
                                    <label for="profilePictureFile" class="upload-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="upload-icon">
                                            <path d="M12 2L3 9l1.4 1.4L11 3.8V16h2V3.8l6.6 6.6L21 9l-9-7z"/>
                                        </svg>
                                        Change Picture
                                    </label>
                                    <input type="file" id="profilePictureFile" accept="image/png,image/jpeg,image/jpg" style="display: none;">
                                </div>
                            </div>
                            <p class="upload-help-text">Supported formats: JPG, JPEG, PNG</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="headline">Headline</label>
                        <input type="text" id="headline" placeholder="e.g., Senior Software Engineer at..." required>
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" placeholder="e.g., Mbabane, Eswatini" required>
                    </div>
                    <div class="form-group">
                        <label for="about">About Summary</label>
                        <textarea id="about" rows="8"
                            placeholder="Write a summary about your professional background..."></textarea>
                    </div>

                    <button type="submit" class="auth-button"
                        style="width: 100%; border-radius: 5px; margin-top: 1rem;">Save Changes</button>
                    <a href="profile.html" class="auth-button"
                        style="width: 100%; border-radius: 5px; margin-top: 1rem; background-color: #777; text-align: center; display: block; box-sizing: border-box;">Cancel</a>
                </form>
            </section>
        </div>
    </main>

    <!-- The Global Chat Window HTML -->
    <div id="global-chat-container" style="display: none;">
        <div id="chat-window">
            <div id="chat-header">
                <button id="chat-back-btn">&larr;</button>
                <span id="chat-header-title">Messages</span>
            </div>
            <div id="chat-conversation-list">
                <!-- List of conversations will be rendered here -->
            </div>
            <div id="chat-messages" style="display: none;">
                <!-- Messages for a specific conversation will be rendered here -->
            </div>
            <form id="chat-form" style="display: none;">
                <input type="text" id="chat-input" placeholder="Write a message..." autocomplete="off">
                <button type="submit" class="apply-button" style="border-radius: 20px;">Send</button>
            </form>
        </div>
        <div id="chat-bubble">
            <div id="chat-notification-dot"></div>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
            </svg>
        </div>
    </div>

    <footer class="main-footer"></footer>

    <script src="../js/main.js"></script>
    <script src="../js/config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // Get references to the form inputs
            const nameInput = document.getElementById('name');
            const headlineInput = document.getElementById('headline');
            const locationInput = document.getElementById('location');
            const aboutInput = document.getElementById('about');
            const form = document.getElementById('editProfileForm');

            // --- Part 1: Fetch current user data to pre-populate the form ---
            try {
                const response = await fetch(`${API_URL}/api/users/me`, {
                    headers: { 'x-auth-token': token }
                });
                if (!response.ok) throw new Error('Could not fetch user data');
                const user = await response.json();

                // Populate the form fields with the data we received
                nameInput.value = user.name || '';
                headlineInput.value = user.headline || '';
                locationInput.value = user.location || '';
                aboutInput.value = user.about || '';

                // Set current profile picture
                const currentProfilePicture = document.getElementById('currentProfilePicture');
                if (user.profilePicture && user.profilePicture.filename) {
                    currentProfilePicture.src = `${API_URL}/api/files/${user.profilePicture.filename}`;
                } else {
                    currentProfilePicture.src = '../assets/placeholder.svg';
                }

            } catch (error) {
                console.error('Failed to load profile for editing:', error);
                showNotification('Could not load your profile data. Please try again.');
                window.location.href = 'profile.html'; // Go back if we can't load data
            }

            // --- Part 2: Handle the form submission when the user clicks "Save" ---
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                // Collect the new values from the form
                const updatedData = {
                    name: nameInput.value,
                    headline: headlineInput.value,
                    location: locationInput.value,
                    about: aboutInput.value
                };

                try {
                    // Send the updated data to the server using a PUT request
                    const response = await fetch(`${API_URL}/api/users`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': token
                        },
                        body: JSON.stringify(updatedData)
                    });

                    if (response.ok) {
                        showNotification('Profile updated successfully!');
                        // This new URL with the timestamp forces the browser to reload the page completely
                        window.location.href = `profile.html?t=${new Date().getTime()}`;
                    } else {
                        showNotification('Failed to update profile. Please try again.');
                    }
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showNotification('An error occurred while updating your profile. Please try again.');
                }
            });

            // Handle profile picture upload
            const profilePictureFile = document.getElementById('profilePictureFile');
            profilePictureFile.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.match(/^image\/(jpeg|jpg|png)$/i)) {
                    showNotification('Please select a valid image file (JPG, JPEG, or PNG)');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('File size must be less than 5MB');
                    return;
                }

                const formData = new FormData();
                formData.append('profilePicture', file);

                try {
                    const response = await fetch(`${API_URL}/api/users/profilePicture`, {
                        method: 'POST',
                        headers: { 'x-auth-token': token },
                        body: formData
                    });

                    if (response.ok) {
                        const updatedUser = await response.json();
                        // Update the preview image
                        const currentProfilePicture = document.getElementById('currentProfilePicture');
                        if (updatedUser.profilePicture && updatedUser.profilePicture.filename) {
currentProfilePicture.src = `${API_URL}/api/files/${updatedUser.profilePicture.filename}?t=${new Date().getTime()}`;
                        }
                        showNotification('Profile picture updated successfully!');
                    } else {
                        const errorData = await response.json();
                        showNotification(errorData.msg || 'Failed to upload profile picture');
                    }
                } catch (error) {
                    console.error('Error uploading profile picture:', error);
                    showNotification('An error occurred while uploading your profile picture');
                }
            });
        });
    </script>
</body>

</html>