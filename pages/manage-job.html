<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Job | JobLinkEswatini</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div id="notification-container"></div>
    
    <header class="main-header">
        <div class="container">
            <div class="header-left">
                <a href="../index.html" class="logo-link">
                    <h1 class="logo">JobLink<span class="logo-eswatini">Eswatini</span></h1>
                </a>
            </div>
            <nav class="main-nav" id="main-nav">
                <a href="jobs.html?view=my-jobs" class="header-nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/>
                    </svg>
                    <span>Jobs</span>
                </a>
                <div class="auth-buttons">
                    <div class="profile-dropdown-container header-nav-item header-nav-item--me" id="loggedInNav">
                        <img src="../assets/placeholder.svg" alt="My Profile" class="nav-profile-pic" id="navProfilePic">
                        <span>Me &#9662;</span>
                        <div class="profile-dropdown-menu" id="profileDropdownMenu">
                            <a href="profile.html" class="dropdown-link">View Profile</a>
                            <a href="#" class="dropdown-link" id="signOutBtn">Sign Out</a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="page-main">
        <div class="container">
            <div class="manage-job-layout">
                <!-- Page Header -->
                <div class="manage-job-header">
                    <div class="breadcrumb">
                        <a href="jobs.html?view=my-jobs">My Jobs</a>
                        <span class="breadcrumb-separator">›</span>
                        <span id="job-title-breadcrumb">Manage Job</span>
                    </div>
                    <div class="header-content">
                        <div class="job-info">
                            <h1 id="job-title" class="manage-job-title">Loading...</h1>
                            <div class="job-meta">
                                <span id="job-status" class="status-badge">—</span>
                                <span class="meta-separator">•</span>
                                <span id="job-location" class="meta-item">—</span>
                                <span class="meta-separator">•</span>
                                <span id="job-type" class="meta-item">—</span>
                                <span class="meta-separator">•</span>
                                <span id="job-posted" class="meta-item">Posted —</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="header-btn header-btn-secondary" id="previewJobBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                                Preview
                            </button>
                            <button class="header-btn header-btn-secondary" id="viewApplicantsBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                                </svg>
                                <span id="applicantsCount">— Applicants</span>
                            </button>
                            <button class="header-btn header-btn-primary" id="viewAnalyticsBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                                </svg>
                                Analytics
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Job Management Tabs -->
                <div class="management-tabs">
                    <button class="tab-btn active" data-tab="details">Job Details</button>
                    <button class="tab-btn" data-tab="status">Status & Visibility</button>
                    <button class="tab-btn" data-tab="settings">Settings</button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Job Details Tab -->
                    <div class="tab-pane active" id="details-tab">
                        <form id="jobDetailsForm" class="job-details-form">
                            <div class="form-section">
                                <h3 class="section-title">Basic Information</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editJobTitle" class="form-label">Job Title</label>
                                        <input type="text" id="editJobTitle" name="title" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="editJobType" class="form-label">Job Type</label>
                                        <select id="editJobType" name="jobType" class="form-select" required>
                                            <option value="full-time">Full-time</option>
                                            <option value="part-time">Part-time</option>
                                            <option value="contract">Contract</option>
                                            <option value="internship">Internship</option>
                                            <option value="freelance">Freelance</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editExperienceLevel" class="form-label">Experience Level</label>
                                        <select id="editExperienceLevel" name="experienceLevel" class="form-select" required>
                                            <option value="entry-level">Entry Level</option>
                                            <option value="mid-level">Mid Level</option>
                                            <option value="senior-level">Senior Level</option>
                                            <option value="executive">Executive</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="editWorkLocation" class="form-label">Work Location</label>
                                        <select id="editWorkLocation" name="location" class="form-select" required>
                                            <option value="mbabane">Mbabane</option>
                                            <option value="manzini">Manzini</option>
                                            <option value="lobamba">Lobamba</option>
                                            <option value="siteki">Siteki</option>
                                            <option value="nhlangano">Nhlangano</option>
                                            <option value="piggs-peak">Pigg's Peak</option>
                                            <option value="remote">Remote</option>
                                            <option value="hybrid">Hybrid</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3 class="section-title">Job Description</h3>
                                <div class="form-group">
                                    <textarea id="editJobDescription" name="description" class="form-textarea" rows="8" required></textarea>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3 class="section-title">Requirements</h3>
                                <div class="form-group">
                                    <textarea id="editJobRequirements" name="requirements" class="form-textarea" rows="6" required></textarea>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3 class="section-title">Compensation</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editSalaryMin" class="form-label">Minimum Salary (SZL)</label>
                                        <input type="number" id="editSalaryMin" name="salaryMin" class="form-input" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="editSalaryMax" class="form-label">Maximum Salary (SZL)</label>
                                        <input type="number" id="editSalaryMax" name="salaryMax" class="form-input" min="0">
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3 class="section-title">Application Settings</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="editApplicationDeadline" class="form-label">Application Deadline</label>
                                        <input type="date" id="editApplicationDeadline" name="deadline" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="editContactEmail" class="form-label">Contact Email</label>
                                        <input type="email" id="editContactEmail" name="contactEmail" class="form-input">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <label class="checkbox-option">
                                            <input type="checkbox" id="editIsEasyApply" name="isEasyApply">
                                            <span class="checkmark"></span>
                                            <span>Enable Easy Apply</span>
                                        </label>
                                        <label class="checkbox-option">
                                            <input type="checkbox" id="editIsUrgent" name="isUrgent">
                                            <span class="checkmark"></span>
                                            <span>Mark as urgent</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" id="discardChangesBtn">Discard Changes</button>
                                <button type="submit" class="btn btn-primary">
                                    <span class="btn-text">Save Changes</span>
                                    <span class="btn-loading" style="display: none;">
                                        <span class="loading-spinner"></span>
                                        Saving...
                                    </span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Status & Visibility Tab -->
                    <div class="tab-pane" id="status-tab">
                        <div class="status-section">
                            <h3 class="section-title">Job Status</h3>
                            <div class="status-controls">
                                <div class="status-options">
                                    <label class="status-option">
                                        <input type="radio" name="jobStatus" value="active">
                                        <div class="status-card">
                                            <div class="status-icon status-active">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                                </svg>
                                            </div>
                                            <div class="status-info">
                                                <h4>Active</h4>
                                                <p>Job is visible to job seekers and accepting applications</p>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="status-option">
                                        <input type="radio" name="jobStatus" value="paused">
                                        <div class="status-card">
                                            <div class="status-icon status-paused">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                                </svg>
                                            </div>
                                            <div class="status-info">
                                                <h4>Paused</h4>
                                                <p>Job is hidden from job seekers but can be reactivated</p>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="status-option">
                                        <input type="radio" name="jobStatus" value="closed">
                                        <div class="status-card">
                                            <div class="status-icon status-closed">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                                </svg>
                                            </div>
                                            <div class="status-info">
                                                <h4>Closed</h4>
                                                <p>Job is permanently closed and no longer accepting applications</p>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                <div class="status-actions">
                                    <button type="button" class="btn btn-primary" id="updateStatusBtn">Update Status</button>
                                </div>
                            </div>
                        </div>

                        <div class="visibility-section">
                            <h3 class="section-title">Visibility Settings</h3>
                            <div class="visibility-stats">
                                <div class="stat-card">
                                    <div class="stat-value" id="totalViews">—</div>
                                    <div class="stat-label">Total Views</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="totalApplications">—</div>
                                    <div class="stat-label">Applications</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="viewsToday">—</div>
                                    <div class="stat-label">Views Today</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="applicationsToday">—</div>
                                    <div class="stat-label">Applications Today</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="tab-pane" id="settings-tab">
                        <div class="settings-section">
                            <h3 class="section-title">Job Settings</h3>
                            
                            <div class="setting-item">
                                <div class="setting-info">
                                    <h4>Email Notifications</h4>
                                    <p>Receive email notifications when someone applies to this job</p>
                                </div>
                                <div class="setting-control">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="emailNotifications">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-item">
                                <div class="setting-info">
                                    <h4>Application Auto-Reply</h4>
                                    <p>Send automatic confirmation email to applicants</p>
                                </div>
                                <div class="setting-control">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoReply">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-item">
                                <div class="setting-info">
                                    <h4>Featured Job</h4>
                                    <p>Promote this job to appear at the top of search results</p>
                                </div>
                                <div class="setting-control">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="featuredJob">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="danger-zone">
                                <h3 class="section-title danger">Danger Zone</h3>
                                <div class="danger-item">
                                    <div class="danger-info">
                                        <h4>Delete Job</h4>
                                        <p>Permanently delete this job posting. This action cannot be undone.</p>
                                    </div>
                                    <button type="button" class="btn btn-danger" id="deleteJobBtn">Delete Job</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/main.js"></script>
    
    <script>
        class ManageJobManager {
            constructor() {
                this.jobId = new URLSearchParams(window.location.search).get('id');
                this.originalJobData = {};
                this.currentJob = {};
                this.isLoading = false;
                this.hasUnsavedChanges = false;
                
                this.init();
            }
            
            init() {
                if (!this.jobId) {
                    notificationModule.showNotification('No job ID specified', 'error');
                    window.location.href = 'jobs.html?view=my-jobs';
                    return;
                }
                
                this.cacheDOMElements();
                this.setupEventListeners();
                this.loadJobData();
            }
            
            cacheDOMElements() {
                // Header elements
                this.jobTitle = document.getElementById('job-title');
                this.jobTitleBreadcrumb = document.getElementById('job-title-breadcrumb');
                this.jobStatus = document.getElementById('job-status');
                this.jobLocation = document.getElementById('job-location');
                this.jobType = document.getElementById('job-type');
                this.jobPosted = document.getElementById('job-posted');
                this.applicantsCount = document.getElementById('applicantsCount');
                
                // Tab elements
                this.tabBtns = document.querySelectorAll('.tab-btn');
                this.tabPanes = document.querySelectorAll('.tab-pane');
                
                // Form elements
                this.jobDetailsForm = document.getElementById('jobDetailsForm');
                this.discardBtn = document.getElementById('discardChangesBtn');
                
                // Status elements
                this.statusRadios = document.querySelectorAll('input[name="jobStatus"]');
                this.updateStatusBtn = document.getElementById('updateStatusBtn');
                
                // Header action buttons
                this.previewJobBtn = document.getElementById('previewJobBtn');
                this.viewApplicantsBtn = document.getElementById('viewApplicantsBtn');
                this.viewAnalyticsBtn = document.getElementById('viewAnalyticsBtn');
                
                // Settings toggles
                this.emailNotifications = document.getElementById('emailNotifications');
                this.autoReply = document.getElementById('autoReply');
                this.featuredJob = document.getElementById('featuredJob');
                this.deleteJobBtn = document.getElementById('deleteJobBtn');
            }
            
            setupEventListeners() {
                // Tab switching
                this.tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
                });
                
                // Form submission
                this.jobDetailsForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
                this.discardBtn.addEventListener('click', () => this.discardChanges());
                
                // Status update
                this.updateStatusBtn.addEventListener('click', () => this.updateJobStatus());
                
                // Header actions
                this.previewJobBtn.addEventListener('click', () => {
                    window.open(`job-details.html?id=${this.jobId}`, '_blank');
                });
                this.viewApplicantsBtn.addEventListener('click', () => {
                    window.location.href = `job-applicants.html?id=${this.jobId}`;
                });
                this.viewAnalyticsBtn.addEventListener('click', () => {
                    window.location.href = `job-analytics.html?id=${this.jobId}`;
                });
                
                // Settings toggles
                [this.emailNotifications, this.autoReply, this.featuredJob].forEach(toggle => {
                    toggle.addEventListener('change', () => this.updateJobSettings());
                });
                
                // Delete job
                this.deleteJobBtn.addEventListener('click', () => this.deleteJob());
                
                // Form change tracking
                this.jobDetailsForm.addEventListener('input', () => this.markAsChanged());
                this.jobDetailsForm.addEventListener('change', () => this.markAsChanged());
                
                // Prevent accidental navigation
                window.addEventListener('beforeunload', (e) => {
                    if (this.hasUnsavedChanges) {
                        e.preventDefault();
                        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                    }
                });
            }
            
            async loadJobData() {
                try {
                    this.setLoading(true);
                    const response = await fetch(`${API_URL}/api/jobs/${this.jobId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (response.ok) {
                        this.currentJob = await response.json();
                        this.originalJobData = { ...this.currentJob };
                        this.populateJobData();
                        this.loadJobStats();
                    } else {
                        throw new Error('Failed to load job data');
                    }
                } catch (error) {
                    console.error('Error loading job:', error);
                    notificationModule.showNotification('Failed to load job data', 'error');
                } finally {
                    this.setLoading(false);
                }
            }
            
            populateJobData() {
                const job = this.currentJob;
                
                // Update header
                this.jobTitle.textContent = job.title;
                this.jobTitleBreadcrumb.textContent = job.title;
                this.updateStatusBadge(job.status);
                this.jobLocation.textContent = job.location;
                this.jobType.textContent = this.formatJobType(job.jobType);
                this.jobPosted.textContent = `Posted ${this.formatDate(job.createdAt)}`;
                
                // Populate form fields
                document.getElementById('editJobTitle').value = job.title || '';
                document.getElementById('editJobType').value = job.jobType || '';
                document.getElementById('editExperienceLevel').value = job.experienceLevel || '';
                document.getElementById('editWorkLocation').value = job.location || '';
                document.getElementById('editJobDescription').value = job.description || '';
                document.getElementById('editJobRequirements').value = job.requirements || '';
                document.getElementById('editSalaryMin').value = job.salaryMin || '';
                document.getElementById('editSalaryMax').value = job.salaryMax || '';
                document.getElementById('editApplicationDeadline').value = job.deadline ? job.deadline.split('T')[0] : '';
                document.getElementById('editContactEmail').value = job.contactEmail || '';
                document.getElementById('editIsEasyApply').checked = job.isEasyApply || false;
                document.getElementById('editIsUrgent').checked = job.isUrgent || false;
                
                // Set status radio
                const statusRadio = document.querySelector(`input[name="jobStatus"][value="${job.status}"]`);
                if (statusRadio) statusRadio.checked = true;
                
                // Set settings toggles
                this.emailNotifications.checked = job.emailNotifications !== false;
                this.autoReply.checked = job.autoReply || false;
                this.featuredJob.checked = job.isFeatured || false;
            }
            
            async loadJobStats() {
                try {
                    const response = await fetch(`${API_URL}/api/jobs/${this.jobId}/stats`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const stats = await response.json();
                        this.updateStatsDisplay(stats);
                    }
                } catch (error) {
                    console.error('Error loading job stats:', error);
                }
            }
            
            updateStatsDisplay(stats) {
                document.getElementById('totalViews').textContent = stats.totalViews || 0;
                document.getElementById('totalApplications').textContent = stats.totalApplications || 0;
                document.getElementById('viewsToday').textContent = stats.viewsToday || 0;
                document.getElementById('applicationsToday').textContent = stats.applicationsToday || 0;
                this.applicantsCount.textContent = `${stats.totalApplications || 0} Applicants`;
            }
            
            switchTab(tabName) {
                // Update tab buttons
                this.tabBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                
                // Update tab panes
                this.tabPanes.forEach(pane => {
                    pane.classList.toggle('active', pane.id === `${tabName}-tab`);
                });
            }
            
            markAsChanged() {
                this.hasUnsavedChanges = true;
            }
            
            async handleFormSubmit(e) {
                e.preventDefault();
                
                if (this.isLoading) return;
                
                this.setLoading(true);
                
                try {
                    const formData = new FormData(this.jobDetailsForm);
                    const jobData = {};
                    
                    for (let [key, value] of formData.entries()) {
                        jobData[key] = value;
                    }
                    
                    // Handle checkboxes
                    jobData.isEasyApply = document.getElementById('editIsEasyApply').checked;
                    jobData.isUrgent = document.getElementById('editIsUrgent').checked;
                    
                    const response = await fetch(`${API_URL}/api/jobs/${this.jobId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(jobData)
                    });
                    
                    if (response.ok) {
                        this.currentJob = await response.json();
                        this.originalJobData = { ...this.currentJob };
                        this.hasUnsavedChanges = false;
                        notificationModule.showNotification('Job updated successfully!', 'success');
                        this.populateJobData();
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to update job');
                    }
                } catch (error) {
                    console.error('Error updating job:', error);
                    notificationModule.showNotification(error.message || 'Failed to update job', 'error');
                } finally {
                    this.setLoading(false);
                }
            }
            
            discardChanges() {
                if (confirm('Are you sure you want to discard all changes?')) {
                    this.populateJobData();
                    this.hasUnsavedChanges = false;
                    notificationModule.showNotification('Changes discarded', 'info');
                }
            }
            
            async updateJobStatus() {
                const selectedStatus = document.querySelector('input[name="jobStatus"]:checked')?.value;
                if (!selectedStatus) {
                    notificationModule.showNotification('Please select a status', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/api/jobs/${this.jobId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ status: selectedStatus })
                    });
                    
                    if (response.ok) {
                        this.currentJob.status = selectedStatus;
                        this.updateStatusBadge(selectedStatus);
                        notificationModule.showNotification('Job status updated successfully!', 'success');
                    } else {
                        throw new Error('Failed to update status');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    notificationModule.showNotification('Failed to update job status', 'error');
                }
            }
            
            async updateJobSettings() {
                const settings = {
                    emailNotifications: this.emailNotifications.checked,
                    autoReply: this.autoReply.checked,
                    isFeatured: this.featuredJob.checked
                };
                
                try {
                    const response = await fetch(`${API_URL}/api/jobs/${this.jobId}/settings`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(settings)
                    });
                    
                    if (response.ok) {
                        notificationModule.showNotification('Settings updated successfully!', 'success');
                    } else {
                        throw new Error('Failed to update settings');
                    }
                } catch (error) {
                    console.error('Error updating settings:', error);
                    notificationModule.showNotification('Failed to update settings', 'error');
                }
            }
            
            async deleteJob() {
                const jobTitle = this.currentJob.title;
                const confirmation = confirm(`Are you sure you want to delete "${jobTitle}"? This action cannot be undone.`);
                
                if (!confirmation) return;
                
                const doubleConfirmation = prompt(`To confirm deletion, please type "${jobTitle}" below:`);
                
                if (doubleConfirmation !== jobTitle) {
                    notificationModule.showNotification('Job title does not match. Deletion cancelled.', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/api/jobs/${this.jobId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (response.ok) {
                        notificationModule.showNotification('Job deleted successfully', 'success');
                        setTimeout(() => {
                            window.location.href = 'jobs.html?view=my-jobs';
                        }, 2000);
                    } else {
                        throw new Error('Failed to delete job');
                    }
                } catch (error) {
                    console.error('Error deleting job:', error);
                    notificationModule.showNotification('Failed to delete job', 'error');
                }
            }
            
            updateStatusBadge(status) {
                this.jobStatus.textContent = this.formatStatus(status);
                this.jobStatus.className = `status-badge status-${status}`;
            }
            
            setLoading(loading) {
                this.isLoading = loading;
                const submitBtn = this.jobDetailsForm.querySelector('button[type="submit"]');
                const btnText = submitBtn.querySelector('.btn-text');
                const btnLoading = submitBtn.querySelector('.btn-loading');
                
                if (loading) {
                    submitBtn.disabled = true;
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'flex';
                } else {
                    submitBtn.disabled = false;
                    btnText.style.display = 'flex';
                    btnLoading.style.display = 'none';
                }
            }
            
            // Utility functions
            formatStatus(status) {
                const statusMap = {
                    'active': 'Active',
                    'paused': 'Paused',
                    'closed': 'Closed',
                    'draft': 'Draft'
                };
                return statusMap[status] || status;
            }
            
            formatJobType(jobType) {
                return jobType.split('-').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }
            
            formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = now - date;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'today';
                if (diffDays === 1) return 'yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
                return date.toLocaleDateString();
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ManageJobManager();
            
            // Initialize header module
            if (typeof headerModule !== 'undefined') {
                headerModule.init();
            }
        });
    </script>
    
    <style>
        .manage-job-layout {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px 0;
        }
        
        .manage-job-header {
            margin-bottom: 32px;
        }
        
        .breadcrumb {
            color: #666;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .breadcrumb a {
            color: #0a66c2;
            text-decoration: none;
        }
        
        .breadcrumb-separator {
            margin: 0 8px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .manage-job-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: #000;
        }
        
        .job-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-paused {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-draft {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .meta-separator {
            color: #ccc;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
        }
        
        .header-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .header-btn-secondary {
            background: white;
            color: #0a66c2;
            border: 1px solid #0a66c2;
        }
        
        .header-btn-secondary:hover {
            background: #f3f2ef;
        }
        
        .header-btn-primary {
            background: #0a66c2;
            color: white;
            border: 1px solid #0a66c2;
        }
        
        .header-btn-primary:hover {
            background: #004182;
        }
        
        .management-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 32px;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab-btn.active {
            color: #0a66c2;
            border-bottom-color: #0a66c2;
        }
        
        .tab-btn:hover:not(.active) {
            color: #333;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .job-details-form {
            background: white;
            border-radius: 8px;
            border: 1px solid #d0d0d0;
        }
        
        .form-section {
            padding: 24px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .form-section:last-of-type {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 20px 0;
            color: #000;
        }
        
        .section-title.danger {
            color: #d92e2e;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row:last-child {
            margin-bottom: 0;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            color: #000;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .form-input, .form-select, .form-textarea {
            padding: 12px 16px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #0a66c2;
            box-shadow: 0 0 0 2px rgba(10, 102, 194, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-option input[type="checkbox"] {
            display: none;
        }
        
        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid #d0d0d0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .checkbox-option input[type="checkbox"]:checked + .checkmark {
            background: #0a66c2;
            border-color: #0a66c2;
        }
        
        .checkbox-option input[type="checkbox"]:checked + .checkmark:after {
            content: "✓";
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .form-actions {
            padding: 24px;
            background: #f9f9f9;
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: white;
            color: #666;
            border: 1px solid #d0d0d0;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #f3f2ef;
        }
        
        .btn-primary {
            background: #0a66c2;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #004182;
        }
        
        .btn-danger {
            background: #d92e2e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-loading {
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Status Tab Styles */
        .status-section, .visibility-section {
            background: white;
            border-radius: 8px;
            border: 1px solid #d0d0d0;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .status-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .status-option {
            cursor: pointer;
        }
        
        .status-option input[type="radio"] {
            display: none;
        }
        
        .status-card {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .status-option input[type="radio"]:checked + .status-card {
            border-color: #0a66c2;
            background: #f8fbff;
        }
        
        .status-card:hover {
            border-color: #0a66c2;
        }
        
        .status-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
        }
        
        .status-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        .status-icon.status-active {
            background: #28a745;
        }
        
        .status-icon.status-paused {
            background: #ffc107;
        }
        
        .status-icon.status-closed {
            background: #dc3545;
        }
        
        .status-info h4 {
            margin: 0 0 4px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .status-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .visibility-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #0a66c2;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        /* Settings Tab Styles */
        .settings-section {
            background: white;
            border-radius: 8px;
            border: 1px solid #d0d0d0;
            padding: 24px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-info h4 {
            margin: 0 0 4px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .setting-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            cursor: pointer;
        }
        
        .toggle-switch input[type="checkbox"] {
            display: none;
        }
        
        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            border-radius: 24px;
            transition: 0.2s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            top: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }
        
        .toggle-switch input[type="checkbox"]:checked + .toggle-slider {
            background: #0a66c2;
        }
        
        .toggle-switch input[type="checkbox"]:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .danger-zone {
            margin-top: 40px;
            padding-top: 24px;
            border-top: 2px solid #dc3545;
        }
        
        .danger-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
        }
        
        .danger-info h4 {
            margin: 0 0 4px 0;
            font-size: 16px;
            font-weight: 600;
            color: #d92e2e;
        }
        
        .danger-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .manage-job-layout {
                padding: 16px;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 12px;
            }
            
            .management-tabs {
                overflow-x: auto;
            }
            
            .tab-btn {
                white-space: nowrap;
            }
            
            .visibility-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .setting-item, .danger-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
    </style>
</body>

</html>
