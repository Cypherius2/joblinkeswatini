<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Profile | JobLinkEswatini</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/theme-tech.css">
</head>

<body>
    <div id="notification-container"></div>
    <header class="main-header">
        <div class="container">
            <div class="header-left">
                <a href="../index.html" class="logo-link">
                    <h1 class="logo">JobLink<span class="logo-eswatini">Eswatini</span></h1>
                </a>
                <div class="header-search-container">
                    <svg class="header-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                    <input type="text" class="header-search-input" placeholder="Search">
                </div>
            </div>

            <nav class="main-nav" id="main-nav">
                <a href="../index.html" class="header-nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                    </svg>
                    <span>Home</span>
                </a>
                <a href="#" class="header-nav-item" id="connectLink">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                    </svg>
                    <span>My Network</span>
                </a>
                <a href="jobs.html" class="header-nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z" />
                    </svg>
                    <span>Jobs</span>
                </a>
                <a href="#" class="header-nav-item" id="messagingLink">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" />
                    </svg>
                    <span>Messaging</span>
                    <span class="notification-badge" id="messaging-notification-dot"></span>
                </a>

                <div class="auth-buttons">
                    <div id="loggedOutNav" style="display: flex;">
                        <a href="login.html" class="header-nav-item">Sign In</a>
                    </div>
                    <div class="profile-dropdown-container header-nav-item header-nav-item--me" id="loggedInNav"
                        style="display: none;">
                        <img src="../assets/placeholder.svg" alt="My Profile" class="nav-profile-pic" id="navProfilePic">
                        <span>Me &#9662;</span>
                        <div class="profile-dropdown-menu" id="profileDropdownMenu">
                            <a href="profile.html" class="dropdown-link">View Profile</a>
                            <a href="edit-profile.html" class="dropdown-link">Edit Profile</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-link" id="themeToggle">
                                <span id="themeToggleIcon">ðŸŒ™</span>
                                <span id="themeToggleText">Dark Theme</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-link" id="signOutBtn">Sign Out</a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="page-main messaging-main">
        <div class="messaging-container">
            <!-- Left Sidebar: Conversations -->
            <aside class="messaging-sidebar">
                <div class="messaging-header">
                    <h2>Messaging</h2>
                    <div class="messaging-actions">
                        <button class="icon-btn" id="new-message-btn" title="New message">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                        </button>
                        <button class="icon-btn" id="messaging-settings-btn" title="Settings">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="messaging-search">
                    <div class="search-input-container">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="text" id="conversation-search" placeholder="Search messages">
                    </div>
                </div>
                
                <div class="conversation-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="unread">Unread</button>
                    <button class="filter-btn" data-filter="archived">Archived</button>
                </div>
                
                <div class="conversation-list-container">
                    <div id="conversation-list" class="conversation-list"></div>
                </div>
            </aside>
            
            <!-- Main Chat Area -->
            <div class="chat-main">
                <!-- Chat Header -->
                <div id="active-chat-header" class="chat-header">
                    <div class="chat-header-placeholder">
                        <div class="placeholder-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                            </svg>
                        </div>
                        <h3>Select a conversation</h3>
                        <p>Choose from your existing conversations or start a new one</p>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div class="chat-messages-container">
                    <div id="active-chat-messages" class="chat-messages"></div>
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input-container">
                    <form id="active-chat-form" class="chat-form">
                        <div class="chat-input-wrapper">
                            <button type="button" class="attachment-btn" title="Attach file">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                                </svg>
                            </button>
                            <input type="text" id="active-chat-input" placeholder="Write a message..." autocomplete="off">
                            <button type="button" class="emoji-btn" id="emoji-btn" title="Add emoji">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                                </svg>
                            </button>
                            <button type="submit" class="send-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Right Sidebar: People & Jobs -->
            <aside class="messaging-right-sidebar">
                <div class="info-card">
                    <div class="card-header">
                        <h3>People you may know</h3>
                        <a href="my-network.html" class="view-all-link">See all</a>
                    </div>
                    <div class="card-content">
                        <div id="discover-people-list" class="people-suggestions"></div>
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="card-header">
                        <h3>Recent job activity</h3>
                        <a href="jobs.html" class="view-all-link">See all jobs</a>
                    </div>
                    <div class="card-content">
                        <div id="discover-jobs-list" class="job-suggestions"></div>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <footer class="main-footer"></footer>

    <script src="../js/theme-toggle.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // --- Cache all DOM Elements for this page ---
            const conversationListEl = document.getElementById('conversation-list');
            const activeChatHeaderEl = document.getElementById('active-chat-header');
            const activeChatMessagesEl = document.getElementById('active-chat-messages');
            const activeChatFormEl = document.getElementById('active-chat-form');
            const activeChatInputEl = document.getElementById('active-chat-input');
            const discoverPeopleListEl = document.getElementById('discover-people-list');
            const discoverJobsListEl = document.getElementById('discover-jobs-list');
            let loggedInUserId = null;
            let currentReceiverId = null;
            let pollingInterval = null;

            // --- Render Functions ---
            const renderConversations = (conversations) => {
                if (!conversations || conversations.length === 0) {
                    conversationListEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                                </svg>
                            </div>
                            <h4>No conversations yet</h4>
                            <p>Start connecting with professionals to begin messaging</p>
                            <a href="my-network.html" class="cta-button">Find connections</a>
                        </div>
                    `;
                    return;
                }
                conversationListEl.innerHTML = conversations.map(convo => {
                    const picUrl = convo.withUser.profilePicture ? `${API_URL}/api/files/${convo.withUser.profilePicture}` : '../assets/placeholder.svg';
                    const timeAgo = getTimeAgo(convo.lastMessageTime || new Date());
                    const isUnread = Math.random() > 0.7; // Mock unread status
                    const lastMessage = convo.lastMessage || 'No messages yet';
                    
                    return `
                        <div class="modern-conversation-item ${isUnread ? 'unread' : ''}" 
                             data-userid="${convo.withUser._id}" 
                             data-username="${convo.withUser.name}" 
                             data-userpic="${picUrl}">
                            <div class="conversation-avatar">
                                <img src="${picUrl}" alt="${convo.withUser.name}">
                                ${isUnread ? '<div class="unread-indicator"></div>' : ''}
                            </div>
                            <div class="conversation-content">
                                <div class="conversation-header">
                                    <h4 class="conversation-name">${convo.withUser.name}</h4>
                                    <span class="conversation-time">${timeAgo}</span>
                                </div>
                                <p class="conversation-preview">${lastMessage.length > 50 ? lastMessage.substring(0, 50) + '...' : lastMessage}</p>
                            </div>
                            <div class="conversation-actions">
                                <button class="conversation-menu-btn" onclick="event.stopPropagation()">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            const renderMessages = (messages) => {
                if (!messages || messages.length === 0) {
                    activeChatMessagesEl.innerHTML = `
                        <div class="messages-empty-state">
                            <div class="empty-message-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                                </svg>
                            </div>
                            <p>No messages yet. Send one to start the conversation!</p>
                        </div>
                    `;
                    return;
                }
                
                let lastDate = null;
                const messagesHTML = messages.map(msg => {
                    const messageDate = new Date(msg.createdAt || Date.now());
                    const dateString = messageDate.toDateString();
                    const timeString = messageDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    let dateHeader = '';
                    if (dateString !== lastDate) {
                        const isToday = dateString === new Date().toDateString();
                        const isYesterday = dateString === new Date(Date.now() - 86400000).toDateString();
                        let displayDate = dateString;
                        if (isToday) displayDate = 'Today';
                        else if (isYesterday) displayDate = 'Yesterday';
                        else displayDate = messageDate.toLocaleDateString();
                        
                        dateHeader = `<div class="message-date-divider"><span>${displayDate}</span></div>`;
                        lastDate = dateString;
                    }
                    
                    const isSent = msg.sender === loggedInUserId;
                    return `
                        ${dateHeader}
                        <div class="message-wrapper ${isSent ? 'sent' : 'received'}">
                            <div class="message-bubble">
                                <div class="message-content">${msg.content}</div>
                                <div class="message-time">${timeString}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                activeChatMessagesEl.innerHTML = messagesHTML;
                activeChatMessagesEl.scrollTop = activeChatMessagesEl.scrollHeight;
            };

            const renderDiscoverPeople = (users) => {
                const filteredUsers = users.slice(0, 3).filter(user => user._id !== loggedInUserId);
                if (filteredUsers.length === 0) {
                    discoverPeopleListEl.innerHTML = '<p class="no-suggestions">No suggestions available</p>';
                    return;
                }
                
                discoverPeopleListEl.innerHTML = filteredUsers.map(user => {
                    const picUrl = user.profilePicture ? `${API_URL}/api/files/${user.profilePicture}` : '../assets/placeholder.svg';
                    const mutualConnections = Math.floor(Math.random() * 15) + 1;
                    
                    return `
                        <div class="person-suggestion">
                            <div class="suggestion-header">
                                <img src="${picUrl}" alt="${user.name}" class="suggestion-avatar">
                                <div class="suggestion-info">
                                    <h4 class="suggestion-name">${user.name}</h4>
                                    <p class="suggestion-title">${user.headline || 'Professional'}</p>
                                    <p class="suggestion-mutual">${mutualConnections} mutual connections</p>
                                </div>
                            </div>
                            <div class="suggestion-actions">
                                <button class="connect-btn" onclick="connectWithUser('${user._id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                    </svg>
                                    Connect
                                </button>
                                <button class="message-btn" onclick="startChatWith('${user._id}', '${user.name}', '${picUrl}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                                    </svg>
                                    Message
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            const renderDiscoverJobs = (jobs) => {
                const recentJobs = jobs.slice(0, 3);
                if (recentJobs.length === 0) {
                    discoverJobsListEl.innerHTML = '<p class="no-suggestions">No recent jobs</p>';
                    return;
                }
                
                discoverJobsListEl.innerHTML = recentJobs.map(job => {
                    const timeAgo = getTimeAgo(job.createdAt || new Date());
                    const applicantCount = Math.floor(Math.random() * 50) + 5;
                    
                    return `
                        <div class="job-suggestion">
                            <div class="job-suggestion-header">
                                <div class="company-logo-small">${job.company.charAt(0).toUpperCase()}</div>
                                <div class="job-suggestion-info">
                                    <h4 class="job-suggestion-title">${job.title}</h4>
                                    <p class="job-suggestion-company">${job.company}</p>
                                    <p class="job-suggestion-meta">${applicantCount} applicants â€¢ ${timeAgo}</p>
                                </div>
                            </div>
                            <a href="job-details.html?id=${job._id}" class="view-job-btn">View job</a>
                        </div>
                    `;
                }).join('');
            };

            // --- Core Logic ---
            const openChat = async (userId, userName, userPic) => {
                if (pollingInterval) clearInterval(pollingInterval);

                currentReceiverId = userId;
                
                // Update chat header with professional layout
                activeChatHeaderEl.innerHTML = `
                    <div class="active-chat-header-content">
                        <div class="chat-user-info">
                            <img src="${userPic}" alt="${userName}" class="chat-user-avatar">
                            <div class="chat-user-details">
                                <h3 class="chat-user-name">${userName}</h3>
                                <p class="chat-user-status">Active now</p>
                            </div>
                        </div>
                        <div class="chat-header-actions">
                            <button class="icon-btn" title="Video call">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                                </svg>
                            </button>
                            <button class="icon-btn" title="Voice call">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
                                </svg>
                            </button>
                            <button class="icon-btn" title="More options">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                activeChatHeaderEl.classList.remove('chat-header-placeholder');
                activeChatHeaderEl.classList.add('chat-header-active');
                
                // Show chat form
                document.querySelector('.chat-input-container').style.display = 'block';
                
                // Load messages
                activeChatMessagesEl.innerHTML = '<div class="loading-messages"><div class="loading-spinner"></div><p>Loading messages...</p></div>';
                
                try {
                    const res = await fetch(`${API_URL}/api/messages/conversation/${userId}`, { headers: { 'x-auth-token': token } });
                    const messages = await res.json();
                    renderMessages(messages);

                    pollingInterval = setInterval(() => {
                        fetch(`${API_URL}/api/messages/conversation/${userId}`, { headers: { 'x-auth-token': token } })
                            .then(res => res.json())
                            .then(renderMessages)
                            .catch(err => console.error('Polling error:', err));
                    }, 5000);
                } catch (err) {
                    activeChatMessagesEl.innerHTML = '<div class="error-state"><p>Could not load messages.</p></div>';
                }
            };

            // --- Helper Functions ---
            function getTimeAgo(date) {
                const now = new Date();
                const diff = now - new Date(date);
                const minutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m`;
                if (hours < 24) return `${hours}h`;
                if (days < 7) return `${days}d`;
                return `${Math.floor(days / 7)}w`;
            }
            
            function connectWithUser(userId) {
                // Mock connection functionality
                showNotification('Connection request sent!', 'success');
            }
            
            function startChatWith(userId, userName, userPic) {
                openChat(userId, userName, userPic);
            }
            
            // --- Event Listeners ---
            conversationListEl.addEventListener('click', (event) => {
                const item = event.target.closest('.modern-conversation-item');
                if (item) {
                    // Remove active class from all conversations
                    document.querySelectorAll('.modern-conversation-item').forEach(conv => conv.classList.remove('active'));
                    // Add active class to clicked conversation
                    item.classList.add('active');
                    item.classList.remove('unread');
                    
                    openChat(item.dataset.userid, item.dataset.username, item.dataset.userpic);
                }
            });
            
            // Conversation filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    // Filter functionality can be implemented here
                });
            });
            
            // Search functionality
            document.getElementById('conversation-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const conversations = document.querySelectorAll('.modern-conversation-item');
                
                conversations.forEach(conv => {
                    const name = conv.dataset.username.toLowerCase();
                    const preview = conv.querySelector('.conversation-preview').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                        conv.style.display = 'flex';
                    } else {
                        conv.style.display = 'none';
                    }
                });
            });

            activeChatFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = activeChatInputEl.value.trim();
                if (!content || !currentReceiverId) return;
                try {
                    await fetch(`${API_URL}/api/messages/${currentReceiverId}`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-auth-token': token }, body: JSON.stringify({ content }) });
                    activeChatInputEl.value = '';
                    const headerImg = activeChatHeaderEl.querySelector('img').src;
                    const headerName = activeChatHeaderEl.querySelector('strong').textContent;
                    openChat(currentReceiverId, headerName, headerImg);
                    // Refresh conversation list in the background for latest message
                    fetch(`${API_URL}/api/messages/conversations`, { headers: { 'x-auth-token': token } }).then(res => res.json()).then(renderConversations);
                } catch (err) { console.error("Failed to send message", err); }
            });

            // --- Initial Data Fetching on Page Load ---
            try {
                const meRes = await fetch(`${API_URL}/api/users/me`, { headers: { 'x-auth-token': token } });
                const me = await meRes.json();
                loggedInUserId = me._id;

                const [convosRes, peopleRes, jobsRes] = await Promise.all([
                    fetch(`${API_URL}/api/messages/conversations`, { headers: { 'x-auth-token': token } }),
                    fetch(`${API_URL}/api/users`),
                    fetch(`${API_URL}/api/jobs`)
                ]);

                const conversations = await convosRes.json();
                const people = await peopleRes.json();
                const jobs = await jobsRes.json();

                renderConversations(conversations);
                renderDiscoverPeople(people);
                renderDiscoverJobs(jobs);

                // Check if we were redirected here to start a chat
                const chatTargetId = localStorage.getItem('startChatWithId');
                const chatTargetName = localStorage.getItem('startChatWithName');
                const chatTargetPic = localStorage.getItem('startChatWithPic');

                if (chatTargetId && chatTargetName && chatTargetPic) {
                    openChat(chatTargetId, chatTargetName, chatTargetPic);
                    localStorage.removeItem('startChatWithId');
                    localStorage.removeItem('startChatWithName');
                    localStorage.removeItem('startChatWithPic');
                }
            } catch (error) {
                showNotification('Failed to load data for messaging center:', error);
                document.querySelector('.messaging-grid-container').innerHTML = '<h2>Error</h2><p>Could not load data. Please try again later.</p>';
            }
        });
    </script>

</body>

</html>